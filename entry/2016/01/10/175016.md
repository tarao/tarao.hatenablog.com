---
Title: はてなブログに移行した
Category:
- hatena
Date: 2016-01-10T17:50:16+09:00
URL: http://tarao.hatenablog.com/entry/2016/01/10/175016
EditURL: https://blog.hatena.ne.jp/tarao/tarao.hatenablog.com/atom/entry/6653586347152444945
---

ようやく, このブログを[http://d.hatena.ne.jp/:title=はてなダイアリー]から[http://hatenablog.com/:title=はてなブログ]に移行した. これまでなかなか移行できていなかった理由や, 移行を機に改めた点についてまとめておく.
====

** 移行のモチベーション

はてなダイアリーは古いサービスで, 文字コードがEUC-JPだったり, 新規の機能追加がないせいで相対的にどんどん不便になっていったり, とにかくさっさと移行すべき. ただ, 後述するように移行作業が億劫になる理由もあった. けっきょく直接的に移行に踏み切ることになったのは, 以下の記事を書いたときに数式を[https://www.mathjax.org/:title=MathJax]で表示できたのがとにかく最高だったから, ということになる.

[http://developer.hatenastaff.com/entry/bookmark-semiring-ac:embed]

ふつうブログを移転するとなると, 古いURLにアクセスされたらどうなるのかとか, はてなスターやはてなブックマークが古いURLに残ってしまわないのかとか, 古いブログのRSSを購読していた人たちはどうなってしまうのかとか, いろいろ気にしないといけない点があるけれど, はてなダイアリーからはてなブログへの移行の場合はこういう点を気にする必要はない. これはありがたい.

>http://help.hatenablog.com/entry/import:title>
STEP2：はてなブックマークの移行

はてなダイアリーの記事についたはてなブックマークを、はてなブログに移行します。

このステップを設定すると、はてなダイアリーの記事についていたはてなブックマークが、それぞれ対応するはてなブログの記事にすべて移ります。

STEP3：記事のリダイレクト設定

はてなダイアリーの記事にアクセスしたときに、対応するはてなブログの記事に自動的に移動（リダイレクト）するよう設定します。この時点で、<strong>はてなダイアリーのRSSフィードも、はてなブログにリダイレクト</strong>します。 (強調引用者)
<<

ちなみに, 古い記事はそのまま残しておいて, RSSフィードだけリダイレクトして, 新規に書かれる記事だけはてなブログに移行するということもできる.

>http://help.hatenablog.com/entry/import#feedredirect:title>
フィードリダイレクト設定

はてなダイアリーのRSSフィードだけを、はてなブログに転送（リダイレクト）させることができます。RSSをリダイレクトすると、RSSリーダーなどでブログの更新を確認しているブログ読者が、そのままではてなブログの更新通知を受け取ることができます。

はてなブログで新たにブログを開設し、はてなダイアリーの更新を停止するが、既存のコンテンツは移行しないという場合などにご利用ください。
<<

今回はどうしても古い記事もすべてはてなブログに移行したかったのでこの方法はとらなかったけれど, これでいいなら後述の問題もなくなってだいぶ楽なので, 移行に際しては検討した方がよさそう.

** 移行の障壁

*** デザインの移植

もちろん, デザインを公式テーマのものに変えてしまうという手もあったけれど, それだとブログのアイデンティティを一度リセットすることになってこれまでの記事を移行してくる意味もない(全く別に新たにブログをはじめるのと大差ない)ので基本的なデザインは引き継ぎたかった.

もともとのデザインは[http://d.hatena.ne.jp/themesample?theme=hatena2-darkgray:title=Hatena2-darkgray]というテーマを元に[http://tarao.hatenablog.com/entry/20100604/1275625104:title=カスタマイズした]ものだったので, テーマストアの[http://blog.hatena.ne.jp/-/store/theme/6435922169449226313:title=Hatena2 for はてなブログ]を元にすれば簡単かとおもいきや, このテーマには以下の問題があって, けっきょくいちからスタイルシートを書くことにした.

- グローバルヘッダが中央カラム表示になっているのでプルダウンメニューの表示位置がずれる
- なんかCSSのあたってないHTML要素がわりとあってどうせ自分で定義しないといけない
- darkgray版はないのでどうせ自分で色指定を上書きしていかないといけない

もともと中央カラムに表示するデザインはそれほど気に入っていなかったので, いちからデザインしなおすついでにレイアウトも見直した. ぜんたいのデザインの再構成が必要なだけでなく, 記事中に<code>class</code>属性つきのタグを直書きして使えるようにしていたり, <code>&lt;style&gt;</code>要素で記事ローカルなスタイルを定義している箇所もあったので, 細かい調整はけっこうたいへんだった. デザイン移植というよりは既存のイメージに近い感じのデザインを新たに書き起こすということになってだいぶ時間がかかってしまった. あまりに時間がかかるのでHatena2とは違うデザインにしたい部分は, イメージに合うものを公式テーマから探してきてCSSを部分的に真似した. [http://blog.hatena.ne.jp/-/store/theme/12921228815720753487:title=Evergreen]がサイドバーなしの簡潔なデザインでだいぶ参考になった.

*** はてな記法の解釈の微妙な違い

はてなダイアリーもはてなブログもはてな記法で利用できるものの, 記法の解釈のされ方が微妙に違う部分があって, <strong>全記事を見直して</strong>崩れてないか確認する必要があった((見直し自体はCSSをあて切れていない部分がないか確認するのにどのみち必要ではあった)). 解釈が違っていることに気づいた主な部分は以下の通り.

- [http://hatenadiary.g.hatena.ne.jp/keyword/p%E3%82%BF%E3%82%B0%E3%81%AE%E6%8C%BF%E5%85%A5%E3%82%92%E6%AD%A2%E3%82%81%E3%82%8B%EF%BC%88p%E3%82%BF%E3%82%B0%E5%81%9C%E6%AD%A2%E8%A8%98%E6%B3%95%EF%BC%89:title=pタグ停止記法]
-- はてなブログではpタグ停止していると<code>&gt;</code>, <code>&lt;</code>がそのまま表示されてしまう場合があった
-- (どういう条件なのか細かく調べていない)
- [http://hatenadiary.g.hatena.ne.jp/keyword/%E8%84%9A%E6%B3%A8%E3%82%92%E3%81%A4%E3%81%91%E3%82%8B%EF%BC%88%E8%84%9A%E6%B3%A8%E8%A8%98%E6%B3%95%EF%BC%89:title=脚注記法]の開始判定
-- はてなブログでは[http://hatenadiary.g.hatena.ne.jp/keyword/%E6%95%B4%E5%BD%A2%E6%B8%88%E3%81%BF%E3%83%86%E3%82%AD%E3%82%B9%E3%83%88%E3%83%96%E3%83%AD%E3%83%83%E3%82%AF%E3%82%92%E4%BD%9C%E3%82%8B%EF%BC%88pre%E8%A8%98%E6%B3%95%EF%BC%89:title=pre記法]内に<code>(&#x200b;(</code>~<code>)&#x200b;)</code>があると脚注記法と判定されてしまう
--- pre記法内で脚注記法が展開される仕様そのものは正しいとおもう(のでどちらかというとはてなダイアリーがおかしい気がする)
--- [http://hatenadiary.g.hatena.ne.jp/keyword/%E3%82%BD%E3%83%BC%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%89%E3%82%92%E8%89%B2%E4%BB%98%E3%81%91%E3%81%97%E3%81%A6%E8%A8%98%E8%BF%B0%E3%81%99%E3%82%8B%EF%BC%88%E3%82%B7%E3%83%B3%E3%82%BF%E3%83%83%E3%82%AF%E3%82%B9%E3%83%BB%E3%83%8F%E3%82%A4%E3%83%A9%E3%82%A4%E3%83%88%EF%BC%89:title=スーパーpre記法]では脚注記法扱いされない
-- これに限らず意図せず記法解釈されてしまう場合は<code>&lt;span&gt;</code>囲う, <code>&amp;#x200b;</code>を挟むなどの対処が必要
- 脚注記法内に書けるタグが異なる
-- はてなブログでは<code>&lt;a&gt;</code>だけ(?)書ける
- <code>&lt;blockquote&gt;</code>内の<code>&lt;cite&gt;</code>
-- 引用記法ではなくHTML要素を直書きした場合, はてなブログでは<code>cite</code>属性や<code>title</code>属性から<code>&lt;cite&gt;</code>要素を補ってくれない
-- (まぁ勝手に補うのもどうかというのはわかる)

** 移行を機に変えたこと

*** レイアウトの変更

[f:id:tarao:20160110203856p:image:w320:right]

元のデザインのように中央カラムに寄せてそれ以外の領域はただのグレーの背景になっているようなレイアウトは, ブラウザの幅を大きくするとなにもないグレーの背景が大半になって見栄えしない. そこでおもいきって中央カラム表示はやめて, ヘッダも本文の領域も横いっぱいになるようにした.

とはいえ, ほんとうに本文が横いっぱいに広がって表示されてしまうと, 横長のディスプレイでブラウザを全画面表示した場合に一行が長すぎて読みづらくなってしまうため, 本文の領域は一定の最大幅におさめてそれ以上は伸長しない方がよい. けれどこれだと中央カラムで表示したのと構造的な本質は変わらず, 横長ディスプレイでは幅がすごく余ることになる. そこで, 幅が一定以上になった場合はサイドバーを表示することにした. もともと[http://tarao.hatenablog.com/entry/20100604/1275625104:title=サイドバー不要派だった]ことをおもえばとんだ宗旨替えに見えなくもないけれど, サイドバーが不要な理由は「本文の表示領域を圧迫するくらいならない方がいい」というものなので, 幅が余ってしかたない場合は表示しても差し支えない.

幅が大きいときだけサイドバーを表示するのは[http://www.w3.org/TR/css3-mediaqueries/:title=CSS3のメディアクエリ]を使えば済むので難しくない. 難しいのは, サイドバーが表示されているときは本文の領域とサイドバーの領域を合わせたものが中央に配置されてほしいというところ. こういうのは常套手段として, 本文領域の外側の要素(<code>#wrapper</code>)を<code>left: 50%</code>で配置しておいて, 本文領域(<code>#main</code>)を<code>left: -50%</code>で配置しつつサイドバーの幅の分だけ<code>margin-right</code>を設定しておくと意図通りにできるようだった. 仕事だと(うちの会社では)こういうのはデザイナの領分でエンジニアは基本的にやらないので勉強になる.

*** プロフィールの表示

[http://tarao.hatenablog.com/entry/20100604/1275625104:title=前のデザイン]ではプロフィールはリンクのみで, 常には表示しないというスタンスだった. これは, 記事は内容こそが大事であって, 誰が書いているかは二の次という気持ちの現れだった. 個人的な立場や経験からの意見を個人の感想のレベルを超えて書かない方がよいとおもっていた. この点は心境の変化というか, 過度に一般化せずに立場や思想を明確にした上で個人的な意見を主張するのはそれなりに有益で, そういう情報を発信する余地をなくすのももったいない, とおもうようになった. そんなわけで, 誰が書いているのか気にする機会もあるだろう, ということでプロフィールは表示することにした.

もう少し身も蓋もない理由としては, RSSが衰退した今となっては, 購読ボタン(「読者になる」ボタン)を表示しないのは一定数の読者にとって不便なのは間違いなく, 購読ボタンを表示するからにはプロフィールのモジュールといっしょになっていないとおさまりが悪い, というのがある.

プロフィールの表示にあたっては元々ブログタイトル下に表示していたカテゴリと注目記事の領域の右側をあけ渡すことにした. ブログタイトル下の要素は<code>position: absolute</code>でけっこう無理に表示しているので, プロフィール分だけよけてカテゴリと注目記事の幅を狭くするのはそれなりに手間だった. ブログタイトル下領域の幅は基本的には本文領域の幅と同じで, 本文領域の幅からプロフィールの幅を引いたものがカテゴリと注目記事の幅ということになる. 最近は<a href="https://drafts.csswg.org/css-values-3/#calc-notation">CSS3の<code>calc</code></a>が使えるのでこういうこともやりやすい. 全体の幅を文字定数として方程式を立てればどう指定すればいいかすぐわかる.

ただし, 本文の領域が最大幅に達していないとき(全体の幅から相対的に計算されるとき)と, 最大幅に達して余白が伸長するときとで<code>calc</code>の計算を変えないといけない. このため, 本文の領域が最大幅に達するときの全体の幅を逆算して, その値を閾値にメディアクエリで<code>calc</code>の内容を変える, ということが必要になった((テクニカルにはcalcに最大値関数がないのが原因なので, そういったものが追加されればメディアクエリで切り替える必要はない)).

*** コメント欄のデザイン

元々のコメント欄のデザインはとくになにも考えずにHatena2-darkgrayのものを角丸にした程度だったけれど, 新しいデザインでは中央カラム表示ではなくなって, サイドバーも箱っぽくないのでコメント欄だけHatena2のデザインになっていても浮いてしまう. なのでコメント欄は今風に大きいアイコンで線で区切ったものにした. 「コメントを書く」ボタンともども[http://blog.hatena.ne.jp/-/store/theme/12921228815720753487:title=Evergreen]の真似.

ふつうのコメント欄のデザインが箱でなくなると, はてなブックマークコメントも箱ではダサい. ただ, ソーシャルパーツとして記事下に配置できるものは<code>&lt;iframe&gt;</code>になるようで, デザインを変えられない. これではあまりにダサいので, JSONPのAPIを叩いてコメントを取得して一覧の要素を構築するJavaScriptを記事下に貼ることにした. これは実は[http://hatenanews.com/:title=はてなニュース]の「記事への反応（ブックマークコメント）」のパクり((といっても, はてなニュースの方の実装も元々自分が仕事で書いたものだ)).

運営会社としての見解ではなく個人的な意見として, JSONP APIはいかなる理由であれ廃止した方がよいとおもっているので, (自分がはてなブックマークの開発に関わっている限り)ゆくゆくはこのAPIは廃止される流れだとおもっている. JSONP APIが廃止された場合, ログイン状況は考慮しない(ゲストユーザでアクセスしたときと同じ情報しかとれない)バージョンのJSON APIが<code>Access-Control-Allow-Origin: *</code>つきでレスポンスを返すようにするのが筋だとおもうけれど, 実際そういうものが提供されるかどうかはわからない. そういうわけで, JSONP版がいつ廃止/仕様変更になったとしても, なんらかの対処ができるという自信がない限りこのやり方はおすすめしない.

*** 細かい要素の変更

はてなダイアリーでは別の記事へのリッチなリンクとして<code>:detail</code>を使っていたり, スライドを埋め込むのに埋め込みタグを直書きしていたりしたのを<code>:embed</code>にほぼ統一した. また, 目次もこれまでは手で書いていたのを目次記法(<code>[:contents]</code>)に統一した.

細かい表示のしかたの調整はいくつもあって, たとえば<code>&lt;blockquote&gt;</code>には引用符(“)を大きく表示してその分インデントされるようにした.

*** 記事の管理方法

これまでは[http://tarao.hatenablog.com/entry/20130110/1357821338:title=自作のEmacs向け記事管理環境]を使っていたけれど, これをはてなブログ対応するのが億劫で移行できないでいる間にid:motemen:detailさんが[http://motemen.hatenablog.com/entry/2014/12/22/blogsync:title=blogsyncという記事をローカルに同期する最高のコマンドラインツール]を作っていたのでこれを使っている((なんかカテゴリに対応してなかったので<a href="https://github.com/motemen/blogsync/pull/7">さっそくpull requestした</a>)).

まだやっていないけれど, ファイルが保存されたらblogsyncを裏で叩いて同期したり, blogsync管理下のファイルを一覧するようなものをEmacsで実装すれば以前と遜色ない使い心地になるのではないかとおもう.

** 感想

はてなブログに移行してとにかくなにもかもモダンになった. 最近はとくに筆が重いのでこれで少しは記事を書く頻度が上がるとよいなぁ.
